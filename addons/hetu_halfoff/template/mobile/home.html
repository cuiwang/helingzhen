{template 'header'}
<link rel="stylesheet" href="{HT}css/Home.css" />
<body>
 {template 'guanzhu'}
	<!--导航栏的开始位置-->
    <header data-am-widget="header" class="am-header am-header-default">
		<div class="am-header-left am-header-nav">
			<a href="{php echo $this->createMobileUrl('halfhome', array('op'=>'city', 'agentid'=>$agentid));}"><span class="am-header-nav-title" id="city">{$dis_name}</span></a>
		</div>
		<i></i>
		<form class="am-header-title" method="post" action="{php echo $this->createMobileUrl('halfhome', array('op'=>'searchBus', 'agentid'=>$agentid));}" onsubmit="return formSearch();">
			<input type="text" id="SearchBar" name="SearchBar" placeholder="搜索"/>
		</form>
		<!-- <i class="iconfont icon_search" style="text-align:center; color:#ffffff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$_W['account']['name']}</i> -->
        <div class="am-header-right am-header-nav">
			<a href="{php echo $this->createMobileUrl('halfnews', array('agentid'=>$agentid));}" class="am-btn am-btn-secondary infoSum"><i class="iconfont remind">&#xe606;</i> <div class="xiaoxiL">{$news_num}</div></a>
        </div>
    </header>
	<!--导航栏的结束位置-->
	<!--轮播图的开始-->
	<div class="slider row">
		<ul>
		{loop $bannerlist $val}
			<li>
				<a href="{$val['url']}">
					<img src="{php echo tomedia($val['img'])}" alt="" width="100%">
				</a>
			</li>
		{/loop}
		</ul>
	</div>
	<!--轮播图的结束-->

	<!--分类的开始-->
	<div class="classify">
		<ul class="classifyone">
			{loop $modilist  $key $list}
				{if $key < 4}
					<li>
						<a href="{$list['url']}">
							<div class="AllClassify">
								<img src="{php echo tomedia($list['img'])}"/>
							</div>
							<p class="classifyName">{$list['name']}</p>
						</a>
					</li>
				{/if}
			{/loop}              
		</ul>
		<ul class="classifyone">
			{loop $modilist  $key $list}
				{if $key > 3}
					<li>
						<a href="{$list['url']}">
							<div class="AllClassify">
								<img src="{php echo tomedia($list['img'])}"/>
							</div>
							<p class="classifyName">{$list['name']}</p>
						</a>
					</li>
				{/if}
			{/loop}
		</ul>
	</div>
	<!--分类的结束-->

	<!-- 今日喜讯的开始位置-->
	<div class="GoodNews">
		<span class="xixun_explain" style="width:30%;"><i class="iconfont xixun">&#xe604;</i>  通知中心</span>
		<div id="news" style="width: 72%; padding-left: 4px; box-sizing: border-box; margin-top: 1px; font-size: 12px;">
			<ul>
			{if empty($news)}
				<li class="text_flow"><a href="#">暂无通知</a></li>
			{else}
				{loop $news $news_son}
					<li class="text_flow">{$news_son['content']}</li>
				{/loop}
			{/if}
			</ul>
		</div>
	</div>
	<!-- 今日喜讯的结束位置-->
	
	<!--今日疯抢这块活动的开始位置-->
	<div class="activityOne">
		<div class="Berserk">
			<a href="{$left_url}"  class="BerserkA">
				<div class="berserkContent">
					<h1 class="textberserk">{$left_title}</h1>
					<p class="Time" value="1462684494">
						<em class="hour">{$left_word[0]}</em>:
						<em class="minute">{$left_word[1]}</em>:
						<em class="second">{$left_word[2]}</em>
					</p>
					<img src="{php echo tomedia($left_img)}" class="BerserkGoodImg"/>
					<h2 class="font12 text_flow">{$left_tleson}</h2>
				</div>
			</a>
		</div>

		<div class="boonAndTicket">
			<div class="weui_panel_bd">
				<a href="{$top_url}" class="weui_media_box weui_media_appmsg">
					<div class="weui_media_bd">
						<h4 class="weui_media_title text_flow" style="color: #7CC2FE;">{$top_title}</h4>
						<p class="weui_media_desc text_flow font12">{$top_tleson}</p>
					</div>
					<div class="weui_media_hd">
						<img src="{php echo tomedia($top_img)}" width="60px" height="60px;"/>
					</div>
				</a>
				<a href="{$bottom_url}" class="weui_media_box weui_media_appmsg">
					<div class="weui_media_bd">
						<h4 class="weui_media_title text_flow" style="color: #FE3595;">{$bottom_title}</h4>
						<p class="weui_media_desc font12 text_flow">{$bottom_tleson}</p>
					</div>
					<div class="weui_media_hd">
						<img src="{php echo tomedia($bottom_img)}" width="60px" height="60px"/>
					</div>
				</a>
			</div>
		</div>
	</div>
	<!--今日疯抢这块活动的结束位置-->
	
	<!--今日五折的开始-->
	<div class="alltitles" style="color: #E34F63;">
		<span><i class="iconfont xixun">&#xe608;</i>&nbsp;今日{$config['zhekou']}</span> 
	</div>
	<!--今日五折的结束-->

	<!-- 五折内容的开始-->
	<div class="weui_cells weui_cells_access YouHui" style="display:block;" id="jwz">
		{loop $bus_list $v}
			<a class="weui_cell" href="{php echo $this->createMobileUrl('halfbus', array('op'=>'shop', 'bus_id'=>$v['bus_id'], 'agentid'=>$agentid))}">
				<div class="weui_cell_hd">
					<img src="{php echo tomedia($v['img'])}" class="ticket_Img"/>
				</div>
				<div class="weui_cell_bd weui_cell_primary">
					<p style="color: #080808;" class="text_flow">{$v['name']}</p>
					<p class="text_flow m-p">{$v['desc_img']}</p>
					<p class="font12">{php echo $this->get_prim_category_name($v['category_id'])}|{php echo $this->get_city($v['county'])}<span style="float: right; color: #E34F63;"></span></p>
					<span class="juli font12" latlng="{$v['lat']}, {$v['lng']}"></span>
				</div>
			</a>
		{/loop}
	</div>
	<!--五折内容的结束-->
	
	<!--查看更多的开始-->
	<div class="clickMore"  onclick="window.location.href='{php echo $this->createMobileUrl('halfoff', array('agentid'=>$agentid));}'">
		>>查看全部<<
	</div>
	<!--查看更多的结束-->
    
  <!--推荐商家的开始-->
	<div class="alltitles" style="color: #E34F63;">
		<span><i class="iconfont tuijian">&#xe609;</i>&nbsp;附近商家</span>
	</div>
	<!-- 推荐商家的结束-->
	
	<!--推荐商家内容的开始-->
	<div class="weui_cells weui_cells_access YouHui shangjia" style="display:block;">
		
	</div>
	<!--推荐商家内容的结束-->
	
	<!--查看更多的开始  ' --> 
	<div class="clickMore" onclick="window.location.href='{php echo $this->createMobileUrl('halfbus', array('op'=>'shopList', 'agentid'=>$agentid));}'">
		>>查看全部<<
	</div>
	<!--查看更多的结束-->
	
	<!--排行榜-->
    <ul class="list clearfix">
        <li><a href="JavaScript: button('renqi')" class="active">人气</a></li>
        <li><a href="JavaScript: button('zuixin')">最新</a></li>
        <li><a href="JavaScript: button('zhekou')">最大折扣</a></li>
    </ul>
    <div class="content">
		{loop $rank_list $rank}
			<a href="{php echo $this->createMobileUrl('halfbus', array('op'=>'shop', 'bus_id'=>$rank['bus_id'], 'agentid'=>$agentid))}">
				<div class="list_detailed">
					<div class="arrange_name">
						<div class="arrange_img">
							<img src="{php echo tomedia($rank['img'])}" class="img_arrange"/>
						</div>
						<div class="arrange_fots">
							<div class="black">
								{if mb_strlen($rank['name'], 'utf-8') > 8} {php echo mb_substr($rank['name'], 0, 8, 'utf-8').'..'} {else} {$rank['name']} {/if}
							</div>
							<div class="greys">
								{if mb_strlen($rank['businesshour'], 'utf-8') > 20} {php echo mb_substr($rank['businesshour'], 0, 20, 'utf-8').'..'} {else} {$rank['businesshour']} {/if}
							</div>
							<div class="greys">{php echo $this->get_prim_category_name($rank['category_id'])}|{php echo $this->get_city($rank['county'])}</div>
						</div>
					</div>
					<div class="discount big_fonts">
						{if $rank['discount_status']=='无'}
							<span class="number"></span>无
						{else}
							<span class="number">{$rank['discount_status']}</span>折
						{/if}
					</div>
				</div>
			</a>
		{/loop}
	</div>
	
	<!--查看更多的开始 2016年9月19日14:57:15添加--> 
	<div class="clickMore" onclick="window.location.href='{php echo $this->createMobileUrl('halfbus', array('op'=>'rank', 'agentid'=>$agentid));}'">
		>>查看全部<<
	</div>
	<!--查看更多的结束 2016年9月19日14:57:22添加-->
      
    <!-- 排行榜结束-->
	<!-- 尾部的开始-->
	{template 'footer'}
	<!-- 尾部的结束-->
</body>
<script type="text/javascript" src="{HT}js/jquery-1.8.2.min.js" ></script>
<script type="text/javascript" src="{HT}js/yxMobileSlider.js" ></script>
<script type="text/javascript" src="{HT}js/dropload.min.js" ></script>
<script src="{HT}js/lyz.delayLoading.min.js" type="text/javascript"></script><!-- 延迟加载的js-->
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" ></script>
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key={$config['qqmapak']}"></script>
<script>
var district;
var longitude;

var latitude;
wx.config({
    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: "{$wxapi['appId']}", // 必填，公众号的唯一标识
    timestamp: '{$wxapi["timestamp"]}', // 必填，生成签名的时间戳
    nonceStr: '{$wxapi["nonceStr"]}', // 必填，生成签名的随机串
    signature: '{$wxapi["signature"]}',// 必填，签名，见附录1
    jsApiList: ['checkJsApi',  'getLocation', 'onMenuShareAppMessage', 'onMenuShareTimeline'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
});
wx.ready(function(){
	wx.getLocation({
	    type : 'gcj02', //默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
		success: function (res) {
			latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
			longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
			var speed = res.speed; // 速度，以米/每秒计
			var accuracy = res.accuracy; // 位置精度
			if(latitude > 1 && longitude > 1){
				for(var i = 0; i < $('.juli').length; i++){
					var latlng = $('.juli').eq(i).attr('latlng').split(',');
					if(latlng[0] > 1 && latlng[1] > 1){
						$('.juli').eq(i).html(getdistance(latlng[0], latlng[1], latitude, longitude));
					}   
				} 
			}
			// if(dis_name == ''){
				// //地址和经纬度之间进行转换服务
				// geocoder = new qq.maps.Geocoder();
				// var latLng = new qq.maps.LatLng(latitude, longitude);
				// geocoder.getAddress(latLng);
				// geocoder.setComplete(function(result){
					// var location = result.detail.addressComponents;
					// var country = location.country; // 国家
					// //左上角显示城市
					// district = location.district;
					// $("#city").html(district);
				// });
			// }else {
				// $("#city").html(dis_name);
			// }
			//进入五折
			var data = {
				latitude:latitude,
				longitude:longitude,
			}
          
			//今日五折
			// $.post("{php echo $this->createmobileurl('halfhome', array('op'=>'today_halfoff', 'agentid'=>$agentid))}",data,function(res){
				// $('#jwz').html('');
				// $('#jwz').html(res);
			// });
			//排行榜
			// $.get("{php echo $this->createmobileurl('halfhome', array('op'=>'paihang', 'agentid'=>$agentid))}",data,function(res){
				// $('.content').html('');
				// $('.content').html(res);
			// });
			//附近商家
			$.post("{php echo $this->createmobileurl('halfhome', array('op'=>'nearby', 'agentid'=>$agentid))}",data,function(data){
				var str = '';
				var res = eval('('+data+')'); //解析json格式数据
				$.each(res, function(index, value) {
					str+='<a class="weui_cell" href="{$_W['siteroot']}app/index.php?i={$_W['uniacid']}&c=entry&op=shop&agentid={$agentid}&do=halfbus&m=hetu_halfoff&bus_id='+value.bus_id+'">';
					str+='<div class="weui_cell_hd">';
					str+='<img originalSrc="{$_W['attachurl']}'+value.img+'"   class="ticket_Img">';
					str+='</div>';
					str+='<div class="weui_cell_bd weui_cell_primary">';
					str+='<p style="color: #080808;" class="text_flow">'+value.name+'';
					if(value.couponnum > 0){ //有优惠券
					str+='<em class="font-class" style="background-color: #2CBBFF;">券</em>';
					str+='<em class="font-class" style="background-color: #FE6D3E;">折</em>';
					}else { //无优惠券
					str+='<em class="font-class" style="background-color: #FE6D3E;">折</em>';
					}
					//2016年6月17日 10:37:36 先设置为“折”
					//str+='<em class="font-class" style="background-color: #FE6D3E;">折</em>';
					if (value.qiang > 0) {
					str+='<em class="font-class">抢</em>';
					}
					if (value.zhe > 0) {
					str+='<em class="font-class" style="background-color: #FE6D3E;">折</em>';
					}
					if (value.quan > 0) {
					str+='<em class="font-class" style="background-color: #2CBBFF;">券</em>';
					}
					if (value.dui > 0) {
					str+='<em class="font-class" style="background-color: rgb(234,50,130);">兑</em>';
					}
					str+='</p>';
					str+='<p class="text_flow m-p">'+value.businesshour+'营业</p>';
					str+='<p class="font12">'+value.cat_name+'|'+value.district_name+' <span style="float: right; color: #E34F63;">'+value.latlng+'km</span></p>';
					str+='</div>';
					str+='</a>';
				});
				$('.shangjia').append(str);
				$("img").delayLoading({
					defaultImg: "/wx/Public/Home/img/loading.jpg",           // 预加载前显示的图片
					errorImg: "",                        // 读取图片错误时替换图片(默认：与defaultImg一样)
					imgSrcAttr: "originalSrc",           // 记录图片路径的属性(默认：originalSrc，页面img的src属性也要替换为originalSrc)
					beforehand: 0,                       // 预先提前多少像素加载图片(默认：0)
					event: "scroll",                     // 触发加载图片事件(默认：scroll)
					duration: "normal",                  // 三种预定淡出(入)速度之一的字符串("slow", "normal", or "fast")或表示动画时长的毫秒数值(如：1000),默认:"normal"
					container: window,                   // 对象加载的位置容器(默认：window)
					success: function (imgObj) { },      // 加载图片成功后的回调函数(默认：不执行任何操作)
					error: function (imgObj) { }         // 加载图片失败后的回调函数(默认：不执行任何操作)
				});
			});
		}
	});
})

function getRad(d){ 
	return d*Math.PI/180.0; 
}

function getdistance(lat1,lng1,lat2,lng2){
	var f = getRad((parseFloat(lat1) + parseFloat(lat2))/2); 
	var g = getRad((parseFloat(lat1) - parseFloat(lat2))/2); 
	var l = getRad((parseFloat(lng1) - parseFloat(lng2))/2); 

	var sg = Math.sin(g); 
	var sl = Math.sin(l); 
	var sf = Math.sin(f); 

	var s,c,w,r,d,h1,h2; 
	var a = 6378137.0; 
	var fl = 1/298.257; 

	sg = sg*sg; 
	sl = sl*sl; 
	sf = sf*sf; 

	s = sg*(1-sl) + (1-sf)*sl; 
	c = (1-sg)*(1-sl) + sf*sl; 

	w = Math.atan(Math.sqrt(s/c)); 
	r = Math.sqrt(s*c)/w; 
	d = 2*w*a; 
	h1 = (3*r -1)/2/c; 
	h2 = (3*r +1)/2/s; 
	// ROUND(6378.138*2*ASIN(SQRT(POW(SIN((37.446705*PI()/180-b.lat*PI()/180)/2),2)+COS(37.446705*PI()/180)*COS(b.lat*PI()/180)*POW(SIN((116.36173*PI()/180-b.lng*PI()/180)/2),2)))*1000);

	return (d*(1 + fl*(h1*sf*(1-sg) - h2*(1-sf)*sg))/1000).toFixed(1)+'km'; 
} 

wx.ready(function(){
	wx.checkJsApi({
		jsApiList: ['getLocation',],
		success: function (res) {
			//alert(JSON.stringify(res));
			// alert(JSON.stringify(res.checkResult.getLocation));
			if (res.checkResult.getLocation == false) {
				alert('你的微信版本太低，不支持微信JS接口，请升级到最新的微信版本！');
				return;
			}
		}
	});
      
	//分享朋友
	wx.onMenuShareAppMessage({
		title: "{$config['share_title']}", // 分享标题
		desc: "{$config['share_desc']}", // 分享描述
		link: "{$_W['siteurl']}", // 分享链接
		imgUrl: "{php echo tomedia($config['share_img']);}", // 分享图标
		success: function () { 
			
		},
		cancel: function () { 
			alert("分享失败，可能是网络问题，一会儿再试试？");
		}
	});
	  
	//分享朋友圈
	wx.onMenuShareTimeline({
		title: "{$config['share_title']}", // 分享标题
		desc: "{$config['share_desc']}", // 分享描述
		link: "{$_W['siteurl']}", // 分享链接
		imgUrl: "{php echo tomedia($config['share_img']);}", // 分享图标
		success: function () {
			
		},
		cancel: function () { 
			alert("分享失败，可能是网络问题，一会儿再试试？");
		}
    });
          
});
    
/*轮播图*/
$(".slider").yxMobileSlider({width:480,height:150,during:5000});
    
/*图片懒加载的*/ 
$("img").delayLoading({
	defaultImg: "{$_W['attachurl']}/images/loading.jpg",           // 预加载前显示的图片
	errorImg: "{$_W['attachurl']}/images/loading.jpg",                        // 读取图片错误时替换图片(默认：与defaultImg一样)
	imgSrcAttr: "originalSrc",           // 记录图片路径的属性(默认：originalSrc，页面img的src属性也要替换为originalSrc)
	beforehand: 0,                       // 预先提前多少像素加载图片(默认：0)
	event: "scroll",                     // 触发加载图片事件(默认：scroll)
	duration: "normal",                  // 三种预定淡出(入)速度之一的字符串("slow", "normal", or "fast")或表示动画时长的毫秒数值(如：1000),默认:"normal"
	container: window,                   // 对象加载的位置容器(默认：window)
	success: function (imgObj) { },      // 加载图片成功后的回调函数(默认：不执行任何操作)
	error: function (imgObj) { }         // 加载图片失败后的回调函数(默认：不执行任何操作)
});
    
//新闻
window.onload = function(){
	$('#news').vTicker({
		speed: 700,
		pause: 3000,
		animation: 'fade',
		mousePause: false,
		showItems: 1
	});
}   
       
    
function formSearch(){
	if($("#SearchBar").val().trim() == ''){
		alert("搜索关键字不能为空！");
		return false;
	}
	return true;
}

function button(stype){
	//排行榜
    //return ;
	$('.active').attr("class", "");
	$('.content').html('');
	$.post("{php echo $this->createmobileurl('halfhome', array('op'=>'paihang', 'agentid'=>$agentid))}",{ latitude:latitude, longitude:longitude,stype:stype },function(res){
		$('.content').html(res);
	});
}
</script>


</html>
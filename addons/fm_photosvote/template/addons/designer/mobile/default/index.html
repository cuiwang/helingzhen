<!doctype html>
<html ng-app="myApp">
<head>
<meta charset="utf-8">
<title>{$share['title']}</title>
<meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
<meta name="format-detection" content="telephone=no" />
<script>var require = {urlArgs: 'v={php echo date('YmdHis');}'};</script>
{php echo register_jssdk()}
<script language="javascript" src="{FM_STATIC_PLUGIN}designer/js/dist/jquery-1.11.1.min.js"></script>
<script language="javascript" src="{FM_STATIC_PLUGIN}designer/js/dist/jquery.gcjs.js"></script>
<link href="{FM_STATIC_PLUGIN}designer/imgsrc/designer.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{FM_STATIC_MOBILE}public/css/style.css">
<link rel="stylesheet" type="text/css" href="{FM_STATIC_PLUGIN}designer/css/style.css">
<link rel="stylesheet" type="text/css" href="{FM_STATIC_PLUGIN}designer/css/bootstrap.min.css">
<link href="../addons/fm_photosvote/static/css/font-awesome.min.css" rel="stylesheet">
<link href="{$_W['siteroot']}app/resource/css/animate.css" rel="stylesheet">
<script type="text/javascript" src="{FM_STATIC_MOBILE}public/photos/js/main.js?ver=1.0"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>
    body {margin:0px; background:#f9f9f9; }
    .fe-mod:hover{border:2px dashed rgba(0,0,0,0); cursor:default;}
    .fe-mod,.fe-mod:hover {border:0px;}
    .fe-mod-cube td {height:auto;}
</style>
<script type="text/javascript">
    function _removeHTMLTag(str) {
        if(typeof str == 'string'){
            str = str.replace(/<script[^>]*?>[\s\S]*?<\/script>/g,'');
            str = str.replace(/<style[^>]*?>[\s\S]*?<\/style>/g,'');
            str = str.replace(/<\/?[^>]*>/g,'');
            str = str.replace(/\s+/g,'');
            str = str.replace(/&nbsp;/ig,'');
        }
        return str;
    }
</script>
</head>
<body >

    <div ng-controller="MainCtrl">
        <!-- 关注按钮 
        {if $guide['followed']!=1}
            <div style="height: 50px;" ng-show="pages[0].params.guide==1"></div>
            <a href="{$guide['shareurl']}">
                <div class="fe-guide" style="position: fixed;" ng-style="{'display':'block','background-color':pages[0].params.guidebgcolor,'opacity':pages[0].params.guideopacity}" ng-show="pages[0].params.guide==1">
                    <div class="fe-guide-faceimg" ng-style="{'border-radius':pages[0].params.guidefacestyle}">
                        <img src="{$guide['logo']}" ng-style="{'border-radius':pages[0].params.guidefacestyle}" />
                    </div>
                    <div class="fe-guide-sub" ng-style="{'color':pages[0].params.guidenavcolor,'background-color':pages[0].params.guidenavbgcolor}">{{pages[0].params.guidesub ||'立即关注'}}</div>
                    <div class="fe-guide-text"  ng-style="{'font-size':pages[0].params.guidesize,'color':pages[0].params.guidecolor}">
                        <p {if empty($guide['title2'])} style="line-height:40px;"{/if}>{$guide['title1']}</p>
                        <p {if empty($guide['title1'])} style="line-height:40px;"{/if}>{$guide['title2']}</p>
                    </div>
                </div>
            </a>
        {/if}-->
        <div ng-repeat="Item in Items" class="fe-mod-repeat">
            <div ng-include="'../addons/fm_photosvote/template/addons/designer/temp/show-'+Item.temp+'.html'" class="fe-mod-parent" id="{{Item.id}}" mid="{{Item.id}}" on-finish-render-filters></div>
        </div>
        <div ng-show="Items==''" style="line-height: 300px; text-align: center; font-size: 14px; color: #999;">
            <div id="core_loading" style="top:50%;left:50%;margin-left:-35px;margin-top:-50%;position:absolute;width:80px;height:60px;"><img src="{FM_STATIC_PLUGIN}designer/images/loading.svg" width="80" /></div>
        </div>
        {if $vote_set['votecansaizhe'] == 1}
          <div class="fe-mod fe-mod-8" ng-show="vote[0].votecansaizhe == 1" ng-style="{'background-color':pages[0].params.votebgcolor}">
              <div class="fe-mod-8-title" ng-show="vote[0].votecansaizhe == 1" ng-style="{'color':pages[0].params.votetitlecolor,'background-color':pages[0].params.votebgcolor}">{{vote[0].votetitle || '未设置投票区标题'}}</div>
               <link href="{FM_STATIC_MOBILE}styleeasy/css/base.css" rel="stylesheet" />
                <style type="text/css">
                  #images .items .bg {background: {{pages[0].params.votealluserbgcolor}};border: 1px solid #c8ab81;}
                  #images .items p .name{color: {{pages[0].params.voteusernamecolor}};}
                  #images .items p .num{color: {{pages[0].params.voteusernamecolor}};}
                  #images .items .sort {background: {{pages[0].params.voteanbgcolor}};}/**投票按钮背景色**/
                  #images .items .sort .piao {color: {{pages[0].params.votepiaoshucolor}};}/**投票按钮背景色**/
                  #images .items .sort .piao a {color: {{pages[0].params.votepiaoshucolor}};font-size:0.7em;}/**投票按钮背景色**/
                  #images .items .vote {color: {{pages[0].params.voteancolor}};background: {{pages[0].params.votesmanbgcolor}} url('{{pages[0].params.voteanimg}}');    border-color: {{pages[0].params.votesmanbgcolor}};}/**投票按钮背景色**/
                </style>
                <div class="tab" id="tab">
                      <div class="tab_bd">
                          <div class="items" style="display: none"><div class="bg"><div class="sort"></div></div></div>
                          <div id="images" ng-style="{'color':pages[0].params.titlecolor,'background-color':pages[0].params.votebgcolor}">
                          </div>
                          <p class='masonryload' ng-show="vote[0].votecansaizhe == 1" ng-style="{'color':pages[0].params.titlecolor,'background-color':pages[0].params.votebgcolor}">数据加载完了</p>
                      </div>
                  </div>
                  

                  <script src="{FM_STATIC_MOBILE}styleeasy/js/fastclick.js"></script>
                  <script src="{FM_STATIC_MOBILE}styleeasy/js/jquery.masonry.min.js"></script>
                  <script src="{FM_STATIC_MOBILE}styleeasy/js/imagesloaded.min.js"></script>
                  <script src="{FM_STATIC_MOBILE}styleeasy/js/common.js"></script>
                <script type="text/javascript">  
                  var index = 1;
                  //var page = 0;
                    $(function() {
                        //FastClick.attach(document.getElementById('tab'));
                        $("#images").empty();
                        ajax_load_data(0,'new');
                        $(window).scroll(function() {
                            // 当滚动到最底部以上100像素时， 加载新内容
                            //if ($(this).scrollTop() + $(window).height() + 100 >= $(document).height() && $(this).scrollTop() > 100) {  
                           if ($(this).scrollTop() + $(this).height() + 20 >= $(document).height() && $(this).scrollTop() > 20) {
                                
                                (function(page) {
                                    ajax_load_data(index,'new')
                                })(++index);
                            }
                        });
                    })
                      
                     function ajax_load_data(index,type) {
                        var $container = $('#images');
                        $container.masonry({
                            itemSelector: '.items',
                            isAnimated: false
                        });

                        var tmoshi = "{$reply['tmoshi']}";
                        $.ajax({
                            url: "{php echo $this->createMobileUrl('pagedatab', array('rid' => $rid,'tagid' => $tagid,'tagpid' => $tagpid))}",
                            type: "post",
                            data: {
                                pagesnum: index,
                                keyword : "{$keyword}"
                            },
                            datatype: "json",
                            success: function(data) {
                                var data = eval('('+data+')');
                                var obj = data[0];
                                
                                var insertHTML = "";
                                $(".masonryload").hide();
                                $(".masonryload").empty();
                                $(".masonryload").append("<img src='{FM_STATIC_MOBILE}styleeasy/img/loading.gif' style='width:10%' >");
                                
                                
                                if(data.length==0){
                                   $(".masonryload").empty();
                                   $(".masonryload").append("数据已加载完");
                                   $(".masonryload").show();
                                }else{
                                 
                                  for (var i = 0; i < data.length; i++) {
                                    if ($.trim(data[i].type) == 'adv') {
                                      insertHTML += "<div class='items'><div class='bg' style='padding: 0;'><a href='" + $.trim(data[i].link) + "'><img src='" + data[i].avatar + "' /></a>";
                                      insertHTML += " <div class='sort text-center' ><span class='vote ' style='float:none;background: transparent;'><a href='" + $.trim(data[i].link) + "' style='color:#fff;text-align:center;'>" + $.trim(data[i].username) + "</a></span></div></div></div>";
                                    }else{
                                      var moshi = "{$rvote['moshi']}";
                                      if (moshi == 2) {
                                         var linkurl = "{php echo $this->createMobileUrl('tuser', array('rid' => $rid))}&tfrom_user=" + $.trim(data[i].from_user);
                                      }else {
                                         var linkurl = "{php echo $this->createMobileUrl('tuserphotos', array('rid' => $rid))}&tfrom_user="+$.trim(data[i].from_user);
                                      }

                                      insertHTML += "<div class='items'><div class='bg'><a href='" + linkurl +"'><img src='" + data[i].avatar + "' /></a>";
                                      if ($.trim(data[i].istuijian) == 1) {
                                        insertHTML += "<img src='http://bbs.012wz.com/static/image/stamp/006.gif' style='position: absolute;top: 10px;  width: 100px;right: 20px;'/>";
                                      }
                                      insertHTML += "<p><span class='name' >" + data[i].username + "</span><span class='num'>" + $.trim(data[i].uid) + "号</span></p>";
                                      insertHTML += " <div class='sort'><span onclick='tvotep(\"" + $.trim(data[i].from_user) + "\")' class='vote btn btn-danger'>{$vote_set['voteanname']}</span><span id='photosnum"+$.trim(data[i].from_user)+"' class='piao' >" + data[i].piao + "<a>票</a></span></div></div></div>";
                                    }
                                  }
                                  
                                }

                                $(".masonryload").show();
                                $boxes = $(insertHTML);
                                  
                                $container.append($boxes).masonry('appended', $boxes);
                                //imagesLoaded 等待图片加载完成后执行masonry
                                $container.imagesLoaded(function() {
                                    $container.masonry();
                                });
                               // var page = index + 1;
                            }
                        });
                    };
                </script> 
          </div>
        {/if}
    </div>

    

<script type="text/javascript" src="{FM_STATIC_PLUGIN}designer/imgsrc/angular.min.js"></script>
{php $_W['angular_loaded']=true}
<script type="text/javascript" src="{FM_STATIC_PLUGIN}designer/imgsrc/hhSwipe.js"></script>
<script type="text/javascript">
    function initswipe(jobj){
        var bullets = jobj.next().get(0).getElementsByTagName('a');
        var banner = Swipe(jobj.get(0), {
            auto: 4000,
            continuous: true,
            disableScroll:false,
            callback: function(pos) {
                var i = bullets.length;
                while (i--) {
                    $(bullets[i]).css("opacity",0.4);
                }
                $(bullets[pos]).css("opacity",0.6);
            }
        })
    }
    var app = angular.module('myApp', []);
    app.controller('MainCtrl', ['$scope', function($scope){
            $scope.shop = {
                uniacid:'{$_W["uniacid"]}'
            };
            $scope.cols = [0,1,2,3];
            $scope.size = $(document.body).width()/4;
            $scope.pages = [{$pageinfo}];
            $scope.system = [{$system}];
            $scope.vote = [{$vote}];
            $scope.Items = [{$data}];
            $scope.show = '1';
           // console.log($scope.Items);
            $scope.hasCube = function(Item){
             
                 var has = false;
                 var row=0,col = 0;
                 for(var i=row;i<4;i++){
                    for(var j=col;j<4;j++){
                      if (Item.params.layout[i][j] && !Item.params.layout[i][j].isempty) {
                          has = true;
                          break;
                      }
                    }
                }
                return has;
                

            }
            $scope.openvote = function(from_user){
                tvote(from_user);
            }
            $scope.$on('ngRepeatFinished',function(){
                $('.fe-mod-2 .swipe').each(function(){
                        initswipe($(this));
                 });
                 $('.fe-mod-8-main-img img').each(function(){
                     $(this).height($(this).width());    
                 });
                 $('.fe-mod-12 img').each(function(){
                     $(this).height($(this).width());    
                 });
                 $('.fe-mod-cube table  tr').each(function(){
                    if( $(this).children().length<=0){
                        $(this).html('<td></td>');
                    }
                 });
           $('#desginer-nav').show();
           $('#footer-nav').show();
           $('#systemcopyright').show();
            });
          
          
    }]);
    
    app.directive('stringHtml' , function(){
        return function(scope , el , attr){
            if(attr.stringHtml){
                scope.$watch(attr.stringHtml , function(html){
                    el.html(html || '');
                });
            }
        };
    });  
    app.directive("onFinishRenderFilters",function($timeout){
        return{
            restrict: 'A',
            link: function(scope,element,attr){
                if(scope.$last === true){
                    $timeout(function(){
                        scope.$emit('ngRepeatFinished');
                    });
                }
            }
        };
    });
</script>
{template 'tvote'}
{php $show_copyright =true}
{if $footertype==1}
    {php $show_footer=true;$footer_current ='first'}
    {template 'fnav'}
{else if $footertype==2}
    {php $show_footer=false;}
    {template 'preview/menu'}
{else}
    {template 'fnav'}
{/if}

{template 'footer'}



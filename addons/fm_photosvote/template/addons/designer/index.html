<script language="javascript">require(['underscore']);</script><!-- 导入CSS样式 --><link href="{FM_STATIC_PLUGIN}designer/imgsrc/designer.css" rel="stylesheet"><!-- 头部选项卡 --><ul class="nav nav-tabs">    <li ><a href="javascript:;"  style="color:red;text-align: center;margin-left: 100px;">页面编辑 {if $datas['stylename']!=''}[ 模板名称: {$datas['stylename']} ]{/if} {if $datas['id']!=''}[ ID: {$datas['id']} 页面：{if $datas['pagetype']==1}投票首页{elseif $datas['pagetype']==2}用户详情{elseif $datas['pagetype']==3}排行榜{elseif $datas['pagetype']==4}报名页面{else $datas['pagetype']==5}描述页面{else}投票首页{/if} ]{/if}</a> </li>    <li class="pull-right"><a href="{php echo $this->createWebUrl('index', array('rid' => $rid))}"  style="color:red">活动中心</a> </li>    <li class="pull-right"><a href="{php echo $this->createWebUrl('templates', array('op' => 'display','rid' => $rid,'type' => 'all'))}">模板首页</a></li>    <li class=" pull-right"><a href="{php echo $this->createWebUrl('templates', array('op' => 'menu','rid' => $rid))}">自定义菜单</a></li>    {if $_GPC['op']=='designer'}<li class="active pull-right"><a href="#">页面编辑</a></li>{/if} </ul><!-- 编辑页面 --><div class='panel panel-default' ng-app="FoxEditor" style="background: #000 url('{FM_STATIC_MOBILE}public/images/kfbg.png')">    <div class='panel-body' ng-controller="FoxController">       <div class="fe-panel-menu">            <div class="kzq"><a href="#">控制器</a></div>            <div ng-repeat="nav in navs">                <nav ng-bind="nav.name" ng-click="addItem(nav.id)"></nav>            </div>        </div>        <div class="fe" style="margin-left: 0%;">                                 <div class="fe-phone">                <div class="fe-phone-left"></div>                <div class="fe-phone-center">                    <div class="fe-phone-top"></div>                    <div class="fe-phone-main">                        <div id="editor">                            <div ng-repeat="page in pages">                                <div ng-include="'../addons/fm_photosvote/template/addons/designer/temp/show-'+page.temp+'.html'" id="{{page.id}}" mid="{{page.id}}" ng-click="setfocus(page.id,$event)"></div>                            </div>                            <div style="height: 50px;" ng-show="pages[0].params.guide==1"></div>                            <div ng-repeat="Item in Items" class="fe-mod-repeat" ng-mouseover="over(Item.id)" ng-mouseleave="out(Item.id)">                                <div class="fe-mod-move" ng-mouseover="drag(Item.id)" ng-click="setfocus(Item.id,$event)"></div>                                <div ng-include="'../addons/fm_photosvote/template/addons/designer/temp/show-'+Item.temp+'.html'" class="fe-mod-parent" id="{{Item.id}}" ng-show="Item" mid="{{Item.id}}" on-finish-render-filters></div>                                <div class="fe-mod-del" ng-click="delItem(Item.id)">移除</div>                            </div>                            <!-- 关注按钮 -->                            <div class="fe-guide" ng-click="setfocus('M0000000000000')" ng-show="pages[0].params.guide==1" ng-style="{'display':'block','background-color':pages[0].params.guidebgcolor,'top':'60px','z-index':'890','opacity':pages[0].params.guideopacity}">                                <div class="fe-guide-faceimg"><img ng-src="{FM_STATIC_PLUGIN}designer/imgsrc/init-data/init-icon.png" ng-style="{'border-radius':pages[0].params.guidefacestyle}" /></div>                                <div class="fe-guide-sub" ng-style="{'color':pages[0].params.guidenavcolor,'background-color':pages[0].params.guidenavbgcolor}">{{pages[0].params.guidesub ||'立即关注'}}</div>                                <div class="fe-guide-text"  ng-style="{'font-size':pages[0].params.guidesize,'color':pages[0].params.guidecolor}">                                    <p ng-class="{'fe-guide-lineheight':pages[0].params.guidetitle2==''}">{{pages[0].params.guidetitle1s || '加关注，做代理。'}}</p>                                    <p ng-class="{'fe-guide-lineheight':pages[0].params.guidetitle1==''}">{{pages[0].params.guidetitle2s || '关注公众号，享专属服务'}}</p>                                </div>                            </div>                            <div class="fe-mod fe-mod-8" ng-click="setfocus('M0000000000000')" ng-show="pages[0].params.cansaizhe == 1" ng-style="{'background-color':pages[0].params.votebgcolor}">                                <div class="fe-mod-8-title"  ng-style="{'color':pages[0].params.votetitlecolor,'background-color':pages[0].params.votebgcolor}">{{pages[0].params.votetitle|| '请填写投票区标题'}}</div>                                <div ng-style="{'color':pages[0].params.votetitlecolor,'font-size':14}" ng-show="pages[0].params.cansaizhe == 1">此处默认展示投票区用户，完整显示查看预览                                    <style type="text/css">                                        #images{ margin: 10px -5px 0;}                                        #images .items{ float: left; width: 49.99%; padding:0 5px 10px; box-sizing:border-box; font-size: 1.1rem;}                                        #images .items img{ display: block; width: 100%;}                                        #images .items .bg{ display: block; padding: 5px; background: #fff; border: 2px solid #c8ab81; box-sizing:border-box;}                                        #images .items p{ line-height: 2.4rem}                                        #images .items p .name{ float: right;}                                        #images .items .sort{ background: #7F355E; color: #fff2d3; border-radius: 5px; padding:.3rem .4rem; overflow: hidden;}                                        #images .items .vote{ float: right; font-size: 1.2rem; color: #ffb; border-radius: 5px; padding: 0 .2rem; line-height: 2.4rem;                                        background: {{pages[0].params.votesmanbgcolor}} url('{{pages[0].params.voteanimg}}'); }                                        #images .items .piao{ font-size: 1.8rem; line-height: 2.4rem;}                                        .masonryload{ font-size: 1.2rem; text-align: center; }                                        #images .items .sort .piao a {font-size:0.7em;}/**投票按钮背景色**/                                                                           </style>                                    <div class="tab" id="tab">                                        <div class="tab_bd">                                            <div id="images" ng-style="{'color':pages[0].params.titlecolor,'background-color':pages[0].params.votealluserbgcolor}">                                                <div class="items">                                                    <div class="bg" ng-style="{'background':pages[0].params.votealluserbgcolor, 'border-color':pages[0].params.votealluserbgcolor}">                                                        <a href="">                                                            <img src="{FM_STATIC_MOBILE}public/images/pimages.jpg">                                                        </a>                                                        <p><span class="name" ng-style="{'color':pages[0].params.voteusernamecolor}">姓名</span><span class="num" ng-style="{'color':pages[0].params.voteusernamecolor}">编号</span></p>                                                        <div class="sort" ng-style="{'background':pages[0].params.voteanbgcolor}"><span class="vote btn btn-danger" ng-style="{'color':pages[0].params.voteancolor,'border-color':pages[0].params.votesmanbgcolor}">{{pages[0].params.voteanname|| '投Ta一票'}}</span>                                                            <span id="photosnumfromUser" class="piao" ng-style="{'color':pages[0].params.votepiaoshucolor}">99<a ng-style="{'color':pages[0].params.votepiaoshucolor}">票</a></span>                                                        </div>                                                    </div>                                                </div>                                                </div>                                            <p class='masonryload' ng-style="{'color':pages[0].params.voteusernamecolor,'background-color':pages[0].params.votealluserbgcolor}">请在实际中预览</p>                                        </div>                                    </div>                                </div>                            </div>                        </div>                    </div>                    <div class="fe-phone-bottom"></div>                </div>                <div class="fe-phone-right"></div>            </div>            <div class="fe-panel">                                <!-- editor start -->                <div class="fe-panel-editor" ng-show="focus">                    <div class="fe-panel-editor-ico"></div>                    <div ng-repeat="Edit in pages">                        <div ng-include="'edit-'+Edit.temp+'.html'" ng-show="focus==Edit.id" Editid="{{Edit.id}}" ></div>                    </div>                    <div ng-repeat="Edit in Items">                        <div ng-include="'edit-'+Edit.temp+'.html'" ng-show="focus==Edit.id" Editid="{{Edit.id}}" tab-index="-1"></div>                    </div>                </div>                <!-- editor end -->            </div>        </div>        <!-- 页面底部保存栏 -->        <div class="fe-save">            <div class="fe-save-main">                <div class="fe-save-info">                    <div class="fe-save-info-type fe-save-info-type-ok" data-type="1">                            {if $pagetype==1 || empty($pagetype)}                                <div class="fe-save-main-radio fe-save-main-radio2">√</div>                                <div class="fe-save-main-text">投票首页</div>                            {else}                                <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>                                <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">投票首页</div>                            {/if}                        </div>                        <div class="fe-save-info-type" data-type="2">                            {if $pagetype==2}                                <div class="fe-save-main-radio fe-save-main-radio2">√</div>                                <div class="fe-save-main-text">用户详情</div>                            {else}                                <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>                                <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">用户详情</div>                            {/if}                                                    </div>                        <div class="fe-save-info-type" data-type="3">                            {if $pagetype==3}                                <div class="fe-save-main-radio fe-save-main-radio2">√</div>                                <div class="fe-save-main-text">排行榜</div>                            {else}                                <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>                                <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">排行榜</div>                            {/if}                                                    </div>                        <div class="fe-save-info-type" data-type="4">                            {if $pagetype==4}                                <div class="fe-save-main-radio fe-save-main-radio2">√</div>                                <div class="fe-save-main-text">报名页面</div>                            {else}                                <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>                                <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">报名页面</div>                            {/if}                                                    </div>                        <div class="fe-save-info-type" data-type="5">                            {if $pagetype==5}                                <div class="fe-save-main-radio fe-save-main-radio2">√</div>                                <div class="fe-save-main-text">介绍页面</div>                            {else}                                <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>                                <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">介绍页面</div>                            {/if}                        </div>                    <input name="pagetype" type="hidden" value="{if empty($pagetype)}1{else}{$pagetype}{/if}" />                    <input name="pagename" type="text" style="height: 30px; width: 300px; border: 1px solid #bbb; border-radius: 3px; margin: 4px 10px; outline: none; padding-left: 10px;" placeholder="页面名称" value="{$datas['pagename']}"/>                </div>                <div class="fe-save-submit2" ng-click="save(2)">保存并预览</div>                <div class="fe-save-submit" ng-click="save(1)">保存</div>            </div>            <div class="fe-save-fold" onclick="fold()"></div>            <div class="fe-save-gotop" onclick="$(document.body).animate({scrollTop:0},500)"><i class="fa fa-angle-up"></i><br>返回顶部</div>             {template 'addons/designer/modal'}        </div>    </div><!-- editor template  page start --><script type="text/ng-template" id="edit-topbar.html">{template 'addons/designer/temp/edit-topbar'}</script><script type="text/ng-template" id="edit-notice.html">{template 'addons/designer/temp/edit-notice'}</script><script type="text/ng-template" id="edit-menu.html">{template 'addons/designer/temp/edit-menu'}</script><script type="text/ng-template" id="edit-banner.html">{template 'addons/designer/temp/edit-banner'}</script><script type="text/ng-template" id="edit-tongji.html">{template 'addons/designer/temp/edit-tongji'}</script><script type="text/ng-template" id="edit-picture.html">{template 'addons/designer/temp/edit-picture'}</script><script type="text/ng-template" id="edit-title.html">{template 'addons/designer/temp/edit-title'}</script><script type="text/ng-template" id="edit-search.html">{template 'addons/designer/temp/edit-search'}</script><script type="text/ng-template" id="edit-line.html">{template 'addons/designer/temp/edit-line'}</script><script type="text/ng-template" id="edit-blank.html">{template 'addons/designer/temp/edit-blank'}</script><script type="text/ng-template" id="edit-pusers.html">{template 'addons/designer/temp/edit-pusers'}</script><script type="text/ng-template" id="edit-richtext.html">{template 'addons/designer/temp/edit-richtext'}</script><script type="text/ng-template" id="edit-cube.html">{template 'addons/designer/temp/edit-cube'}</script><!-- editor template page end --></div><script type="text/javascript" src="{FM_STATIC_PLUGIN}designer/imgsrc/angular.min.js"></script><script type="text/javascript" src="{FM_STATIC_PLUGIN}designer/imgsrc/angular-ueditor.js"></script><script type="text/javascript" src="{FM_STATIC_PLUGIN}designer/imgsrc/hhSwipe.js"></script><script type="text/javascript" src="./resource/components/ueditor/ueditor.config.js"></script><script type="text/javascript" src="./resource/components/ueditor/ueditor.all.min.js"></script><script type="text/javascript" src="./resource/components/ueditor/ueditor.parse.js"></script><script type="text/javascript" src="./resource/components/ueditor/lang/zh-cn/zh-cn.js"></script><script type="text/javascript">    // 百度编辑器初始化    var opts = {type: 'image',direct: false,multi: true,tabs: {'upload': 'active','browser': '','crawler': ''},path: '',dest_dir: '',global: false,thumb: false,width: 0};    UE.registerUI('myinsertimage',function(editor, uiName) {        editor.registerCommand(uiName, {            execCommand: function() {                require(['fileUploader'],                function(uploader) {                    uploader.show(function(imgs) {                        if (imgs.length == 0) {                            return;                        } else if (imgs.length == 1) {                            editor.execCommand('insertimage', {                                'src': imgs[0]['url'],                                '_src': imgs[0]['attachment'],                                'width': '100%',                                'alt': imgs[0].filename                            });                        } else {                            var imglist = [];                            for (i in imgs) {                                imglist.push({                                    'src': imgs[i]['url'],                                    '_src': imgs[i]['attachment'],                                    'width': '100%',                                    'alt': imgs[i].filename                                });                            }                            editor.execCommand('insertimage', imglist);                        }                    },                    opts);                });            }        });        var btn = new UE.ui.Button({            name: '插入图片',            title: '插入图片',            cssRules: 'background-position: -726px -77px',            onclick: function() {                editor.execCommand(uiName);            }        });        editor.addListener('selectionchange',        function() {            var state = editor.queryCommandState(uiName);            if (state == -1) {                btn.setDisabled(true);                btn.setChecked(false);            } else {                btn.setDisabled(false);                btn.setChecked(state);            }        });        return btn;    },    19);	</script><script>    $(function(){        require(['util'], function (util) {            var preview_id = util.cookie.get('preview_id');            if(preview_id){                preview(preview_id);            }        });       $(".fe-save-info-type-ok").click(function(){           var pagetype = $(this).data("type");           if(pagetype!='2' || pagetype!='3'){                $(this).find(".fe-save-main-radio").addClass("fe-save-main-radio2").text("√");                $(this).siblings().find(".fe-save-main-radio").removeClass("fe-save-main-radio2").text("");           }           $("input[name=pagetype]").val(pagetype);       });     });    function switchtab(tag,n){        $("#"+tag+"-"+n).fadeIn().siblings().hide();        $("#"+tag+"-nav-"+n).addClass("active").siblings().removeClass("active");    }    function fold(){        width= $(".fe-save").width();        left = $(".fe-save").css("left");        left = left.replace("px","");        if(left>=0){            $(".fe-save").animate({left:0-width+40+"px"},1000);            $(".fe-save-fold").addClass("fe-save-fold2");        }else{            $(".fe-save").animate({left:"0px"},1000);            $(".fe-save-fold").removeClass("fe-save-fold2");        }    }    function preview(pageid){        var url = "{php echo $_W['siteroot'].'./app/'.$this->createMobileUrl('preview')}&preview=1&pageid="+pageid;        $('#modal-module-menus3').find("iframe").attr("src",url);        popwin = $('#modal-module-menus3').modal();        require(['util'], function (util) {            util.cookie.set('preview_id','');        });    }    function setcookie(id){        require(['util'], function (util) {            util.cookie.set('preview_id',id);        });    }    function clone(myObj){        if(typeof(myObj) != 'object' || myObj == null) return myObj;        var newObj = new Object();        for(var i in myObj){            newObj[i] = clone(myObj[i]);        }        return newObj;    }    function cloneArr(arr){        var newArr = [];        $(arr).each(function(i,val){             newArr.push(clone(val));        });        return newArr;    }    function initswipe(jobj){        var bullets = jobj.next().get(0).getElementsByTagName('a');        var banner = Swipe(jobj.get(0), {            auto: 2000,            continuous: true,            disableScroll:false,            callback: function(pos) {                var i = bullets.length;                while (i--) {                    bullets[i].className = '';                }                bullets[pos].className = 'cur';            }        })    }     var myModel = angular.module('FoxEditor',['ng.ueditor']);    myModel.controller('FoxController', ['$scope', function($scope){            $scope.navs = [                {id:'notice',name:'公告',params:{color:'',bgcolor:'',notice:'',noticehref:'',scroll:'0'}},                {id:'tongji',name:'统计',params:{color:'',bgcolor:'',notice:'',noticehref:'',scroll:'0'}},                {id:'banner',name:'轮播',params:{shape:'',align:'center',scroll:'2',bgcolor:''},                   data:[                       {id:'B0000000000001',imgurl:'{FM_STATIC_PLUGIN}designer/imgsrc/init-data/init-image-3.jpg',hrefurl:'http://www.baidu.com',sysurl:'url',},                       {id:'B0000000000002',imgurl:'{FM_STATIC_PLUGIN}designer/imgsrc/init-data/init-image-2.jpg',hrefurl:'http://www.qq.com',sysurl:'url'},                       {id:'B0000000000003',imgurl:'{FM_STATIC_PLUGIN}designer/imgsrc/init-data/init-image-6.jpg',hrefurl:'http://www.sina.com',sysurl:'url'}                   ]                },                {id:'title',name:'标题',params:{title1:'',title2:'',showtitle2:'1',fontsize1:'18px',fontsize2:'14px',align:'left',color:'#000',}},                {id:'search',name:'搜索框',params:{placeholder:'搜索: 请输入您要查找的编号或者姓名',style:'style1','color':'','bgcolor':'','bordercolor':'',searchurl:'{php echo $this->createMobileUrl("photosvote")}',uniacid:'{$_W["uniacid"]}'}},                {id:'line',name:'辅助线',params:{height:'2px',style:'dashed',color:'#000'}},                {id:'blank',name:'辅助空白',params:{height:'100px',bgcolor:''}},                {id:'pusers',name:'推荐',params:{style:'49.5%',showtitle:'0',titlecolor:'',bgcolor:'',showname:'1',title:'',price:'1',toupiao:'1',userh:'{php echo $this->createMobileUrl("tuser")}'},data:[]},                {id:'richtext',name:'富文本',params:{bgcolor:'',},content:''},                {id:'menu',name:'按钮组',params:{num:'20%',style:'0',bgcolor:'#fff',},                    data:[{id:'F0000000000001',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000002',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000003',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000004',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000005',imgurl:'',text:'',hrefurl:'',color:''}]                },                {id:'picture',name:'单图',params:{},data:[{id:'P0000000000001',imgurl:'{FM_STATIC_PLUGIN}designer/imgsrc/init-data/init-image-4.jpg',hrefurl:'',option:'0'}]},                {id: "cube",name: "图片魔方",params: {bgcolor:'',layout: {},showIndex: 0,selection: {},currentPos: {},currentLayout: {isempty: !0}},data:[]}            ];            $scope.shop = {uniacid:'{$_W["uniacid"]}'};            $scope.system = [{$system}];            $scope.pages = [{$pageinfo}];            $scope.Items = [{$data}];             $scope.underscore = null;            require(['underscore'],function(underscore){                $scope.underscore = underscore;            });            $scope.hasCube = function(Item){                         	 var has = false;                 var row=0,col = 0;            	 for(var i=row;i<4;i++){                    for(var j=col;j<4;j++){                      if (!$scope.underscore.isUndefined(Item.params.layout[i][j]) && !Item.params.layout[i][j].isempty) {                          has = true;                          break;                      }                    }                }                return has;                            }            $scope.showSelection = function(Edit, row,col){                             Edit.params.currentPos = {row: row,col: col};                Edit.params.selection = {};                var maxrow = 4,maxcol = 4,end =false;                                for(var i=row;i<=3;i++){                	                    if ($scope.underscore.isUndefined(Edit.params.layout[i][col]) || !$scope.underscore.isUndefined(Edit.params.layout[i][col]) && !Edit.params.layout[i][col].isempty) {                        maxrow = i;                        end =true;                    }                    if(end){                        break;                    }                }                          end =false;                for(var j=col;j<=3;j++){                    if ( $scope.underscore.isUndefined(Edit.params.layout[row][j]) || !$scope.underscore.isUndefined(Edit.params.layout[row][j]) && !Edit.params.layout[row][j].isempty) {                        maxcol = j;                        end =true;                    }                     if(end){                        break;                    }                }                                var f = -1,g = 1;                              for (var i = row; i < maxrow; i++) {	                                    var y = 1;                    Edit.params.selection[g] = {};                    for (var j = col; j < maxcol; j++) {                      if( f >= 0 && f < j || (!$scope.underscore.isUndefined(Edit.params.layout[i][j]) && Edit.params.layout[i][j].isempty   )){                          Edit.params.selection[g][y] = {                            rows: g,                            cols: y                          };                          y++;                      }                      else{                          f = j - 1                      }                    }                     g++;                }                                $(".layout-table li").removeClass("selected");                $scope.modalobj = $("#"+Edit.id+"-modal-cube-layout").modal({show:true});                $('#'+Edit.id+'-modal-cube-layout').find(".layout-table").unbind('mouseover').mouseover(function(a) {                    if ("LI" == a.target.tagName) {                        $(".layout-table li").removeClass("selected");                        var c = $(a.target).attr("data-rows"),                              d = $(a.target).attr("data-cols");                        $(".layout-table li").filter(function(a, e) {                            return $(e).attr("data-rows") <= c && $(e).attr("data-cols") <= d                        }).addClass("selected")                    }                });                                return true;            }            $scope.selectLayout = function(Edit, currentRow, currentCol, rows, cols) {                if( $scope.underscore.isUndefined(rows) ) {rows= 0;}                if( $scope.underscore.isUndefined(cols) ) {cols = 0;}                Edit.params.layout[currentRow][currentCol] = {                    cols: cols,                    rows: rows,                    isempty: false,                    imgurl: "",                    classname: "index-" + Edit.params.showIndex                };                for (var i = parseInt(currentRow); i < parseInt(currentRow) + parseInt(rows); i++){                    for (var j = parseInt(currentCol); j < parseInt(currentCol) + parseInt(cols); j++) {                        if( currentRow != i || currentCol != j)  {                            delete Edit.params.layout[i][j];                        }             	}                }                Edit.params.showIndex++;                $scope.modalobj.modal('hide');                $scope.changeItem(Edit, currentRow,currentCol);                   return true;            }            $scope.changeItem = function(Edit,row,col){                $("#cube-editor td").removeClass("current").filter(function(a, e) {                    return $(e).attr("x") == row && $(e).attr("y") == col                }).addClass("current");                $("#cube_thumb").attr("src", "");                Edit.params.currentLayout = Edit.params.layout[row][col];            }             $scope.delCube = function(Edit,Cid,cols,rows){                if(Edit && Cid && cols && rows){                    var len = Edit.params.layout.length;                    $.each(Edit.params.layout,function(row,a){                        $.each(Edit.params.layout[row],function(col,b){                            if(col!='$$hashKey'){                                if(b.classname==Edit.params.currentLayout.classname){                                    row  =parseInt(row);col = parseInt(col);                                    rows  =parseInt(rows);cols = parseInt(cols);                                     for(var i = row;i<row+rows;i++){                                         for(var j=col;j<col+cols;j++){                                            Edit.params.layout[i][j] = {cols: 1,rows: 1,isempty: true,imgurl: "",classname: ""};                                         }                                     }                                }                            }                        });                                            });                }            }                                      // 1.1 添加一条子级(good,picture,banner)            $scope.addItemChild =function(type,Mid){                if(type && Mid){                    t = '';                    if(type=='good'){t = 'G';}                    else if(type=='picture'){t = 'P';}                    else if(type=='banner'){t = 'B';}                    var var_id = t+new Date().getTime();                    var push = {                        banner:{id:var_id,imgurl:'',hrefurl:'',sysurl:'url'},                        picture:{id:var_id,imgurl:'',hrefurl:'',option:'0'},                        good:{}                    };                    var Items = $scope.Items;                    angular.forEach(Items, function(m,index) {                        if(m.id==Mid){                            m.data.push(push[type]);                            //console.log(push[type]);                        }                    });                }            }            // 1.1 删除一条子级            $scope.delItemChild = function(Mid,Cid){                if(confirm("此操作不可逆，确认移除？")){                    var Items = $scope.Items;                    angular.forEach(Items, function(m,index1) {                        if(m.id==Mid){                            angular.forEach(m.data, function(c,index2) {                                if(c.id==Cid){                                    m.data.splice(index2,1);                                }                            });                        }                    });                }            }            // 1.1 上传图片            $scope.uploadImgChild = function(Mid,Cid,Type){                require(['jquery', 'util'], function($, util){                    util.image('',function(data){                            var Items = $scope.Items;                            angular.forEach(Items, function(m,index1) {                                if(m.id==Mid){                                    if(Type=='cube'){                                        m.params.currentLayout.imgurl = data['url'];                                        $("div[mid="+Mid+"]").mouseover();                                                                            }else{                                        angular.forEach(m.data, function(c,index2) {                                            if(c.id==Cid){                                                c.imgurl = data['url'];                                                $("div[mid="+Mid+"]").mouseover();                                                //console.log(Items);                                            }                                        });                                    }                                }                            });                    });                });            }                       $scope.chooseUrlCube = function(Mid,Cid){                var Items = $scope.Items;                angular.forEach(Items, function(m) {                    if(m.id==Mid){                        m.params.currentLayout.url = 'http://www.qq.com';                        $("div[mid="+Mid+"]").mouseover();                    }                });            }            // 1.1 选择链接            $scope.chooseUrl = function(Mid,Cid,T){                $('#floating-link').attr({"Mid":Mid,"Cid":Cid,T:T});                $('#floating-link').modal();            }            $scope.chooseLink = function(type,hid){                var Mid = $('#floating-link').attr("Mid");                var Cid =  $('#floating-link').attr("Cid");                var T =  $('#floating-link').attr("T");                var rid =  $("#choose-rid").val();                if (rid == '' || rid == null) {                    alert('请选择活动！');                    return false                }                var url = $("#fe-tab-link-"+type+" #fe-tab-link-li-"+hid).data("href")+"&rid="+rid;                if(url && Mid && Cid){                    angular.forEach($scope.Items, function(m,index1) {                        if(m.id==Mid){                            if(T=='cube'){                                m.params.currentLayout.url = url;                                $("div[mid="+Mid+"]").mouseover();                            }else{                                angular.forEach(m.data, function(c,index2) {                                    if(c.id==Cid){                                        c.hrefurl = url;                                    }                                });                            }                        }                    });                    $('#floating-link').attr({"Mid":'',"Cid":'',T:''});                    $('#floating-link .close').click();                }            }            $scope.temp = {                notcie:[]            };            $scope.ajaxselect =function(type){                val = $("#select-"+type+"-kw").val();                mid = $("#floating-link").attr("mid");                $.ajax({                    type: 'post',                    dataType:'json',                    url: "{php echo $this->createWebUrl('templates',array('op'=>'api','apido'=>'selectlink'))}",                    data: {kw:val,type:type},                    success: function(data){                        $scope.temp[type]=data;                        $("div [mid="+mid+"]").mouseover();                    },                    error: function(){                        alert('查询失败！请刷新页面。');                    }                });            }                        $scope.focus = 'M0000000000000';            $scope.keyword = function(val,Eid){                $.ajax({                    type: 'post',                    url: "{php echo $this->createWebUrl('templates',array('op'=>'api','apido'=>'selectkeyword'))}",                    data: {kw:val,pid:"{$pageid}"},                    success: function(data){                        if(data != 'ok'){                            window.dosave = '1';                            $("div[Editid="+Eid+"]").find(".keyword").css('border',"#f01 solid 1px");                        }else{                            window.dosave = '0';                            $("div[Editid="+Eid+"]").find(".keyword").css('border',"#ddd solid 1px");                        }                    },                    error: function(){                        alert('查询商品信息失败！请刷新页面。');                    }                });            }            $scope.selectusers = function(Mid){                var kw = $("#secect-kw").val(),                    rid = $("#secect-rid").val();                //console.log(rid);                $.ajax({                    type: 'post',                    dataType:'json',                    url: "{php echo $this->createWebUrl('templates',array('op'=>'api','apido'=>'selectusers'))}",                    data: {kw:kw,rid:rid},                    success: function(data){                        $scope.selectUsers = [];                        angular.forEach(data, function(d,i) {                            Sid = 'S'+new Date().getTime();                            $scope.selectUsers.push({id:Sid+i,name:data[i].name,img:data[i].mphotos,usersid:data[i].id,uid:data[i].uid,piaoshu:data[i].piaoshu,renqi:data[i].renqi,sharenum:data[i].sharenum,rid:data[i].rid,from_user:data[i].from_user});                        });                        $("div[mid="+Mid+"]").mouseover();                    },                    error: function(){                        alert('查询商品信息失败！请刷新页面。');                    }                });            }            $scope.pushGood = function(Mid,Sid){                var repaction =  $('#floating-good').attr("action");                var repGid =  $('#floating-good').attr("Gid");                angular.forEach($scope.Items, function(m,index1) {                    if(m.id==Mid){                        angular.forEach($scope.selectUsers, function(s,index2) {                            if(s.id==Sid){                                if(repaction=='replace' && repGid){                                    // 执行替换                                    angular.forEach(m.data, function(r,index3) {                                        if(r.id==repGid){                                            var Gid = 'G'+new Date().getTime();                                            r.id = Gid;                                            r.img = s.img;                                            r.usersid = s.usersid;                                            r.name = s.name;                                            r.realname = s.realname;                                            r.uid = s.uid;                                            r.piaoshu = s.piaoshu;                                            r.renqi = s.renqi;                                            r.sharenum = s.sharenum;                                            r.rid = s.rid;                                            r.from_user = s.from_user;                                            $('#floating-good .close').click();                                        }                                    });                                }                                else if(!repaction){                                    var Gid = 'G'+new Date().getTime();                                    var userh = '{php echo $_W['siteroot'].'./app/'.$this->createMobileUrl("tuser")}';                                    // 执行添加                                    m.data.push({id:Gid,img:s.img,mphotos:s.mphotos,usersid:s.usersid,name:s.name,realname:s.realname,uid:s.uid,piaoshu:s.piaoshu,renqi:s.renqi,sharenum:s.sharenum,rid:s.rid,from_user:s.from_user, userh:userh});                                }                            }                        });                    }                });            }            $scope.selectUsers = [];                        $scope.load = function(){}            $scope.changeImg = function(Mid,n){                width = parseInt($(".fe-mod-move").width());                height = (width* parseInt( n.replace("%","") ) /100)-16;                $("div[mid="+Mid+"] .fe-mod-8-main-img img").height(height);            };            $scope.setimg = function(Mid,n){                width = $(".fe-mod-move").width();                n = n.replace("%","");                n = n/100;                $("div[mid="+Mid+"] .fe-mod-12 img").height(width*n-30);            }            $scope.setfocus = function(Mid,e){                $scope.focus = Mid;                ccc = $("div[id="+Mid+"]").offset().top;                 ddd = (ccc-144)>=0?(ccc-144):0;                $(".fe-panel-editor").css("margin-top",ddd+"px");                $(document.body).animate({scrollTop:ccc-100},500);            }            $scope.drag = function(Mid){                var container = $("#editor");                                var del = container.find(".fe-mod-move");                del.off("mousedown").mousedown(function(e) {                    $scope.focus = Mid;                    if(e.which != 1 || $(e.target).is("textarea") || window.kp_only) return;                    e.preventDefault();                     var x = e.pageX;                    var y = e.pageY;                    var _this = $(this).parent();                     var w = _this.width();                    var h = _this.height();                    var w2 = w/2;                    var h2 = h/2;                    var p = _this.position();                    var left = p.left;                    var top = p.top;                    window.kp_only = true;                    _this.before('<div id="kp_widget_holder"></div>');                    var wid = $("#kp_widget_holder");                    var nod = $(".fe-mod-nodrag");                    wid.css({"border":"2px dashed #ccc", "height":_this.outerHeight(true)});                    _this.css({"width":w, "height":h, "position":"absolute", opacity: 0.8, "z-index": 900, "left":left, "top":top});                    $(document).mousemove(function(e) {                        $scope.focus = Mid;                        e.preventDefault();                        var l = left + e.pageX - x;                        var t = top + e.pageY - y;                        _this.css({"left":l, "top":t});                        var ml = l+w2;                        var mt = t+h2;                        del.parent().not(_this).not(wid).each(function(i) {                            var obj = $(this);                            var p = obj.position();                            var a1 = p.left;                            var a2 = p.left + obj.width();                            var a3 = p.top;                            var a4 = p.top + obj.height();                            if(a1 < ml && ml < a2 && a3 < mt && mt < a4) {                                if(!obj.next("#kp_widget_holder").length) {                                    wid.insertAfter(this);                                }else{                                    wid.insertBefore(this);                                }                                return;                            }                        });                    });                    $(document).mouseup(function() {                        $(document).off('mouseup').off('mousemove');                        $(container).each(function() {                            var obj = $(this).children();                            var len = obj.length;                            if(len == 1 && obj.is(_this)) {                                $("<div></div>").appendTo(this).attr("class", "kp_widget_block").css({"height":100});                            }                            else if(len == 2 && obj.is(".kp_widget_block")){                                $(this).children(".kp_widget_block").remove();                            }                        });                        var p = wid.position();                        _this.animate({"left":p.left, "top":p.top}, 100, function() {                            _this.removeAttr("style");                            wid.replaceWith(_this);                            window.kp_only = null;                            var arr = [];                            $(".fe-mod-repeat").find(".fe-mod-parent").each(function(i,val) {                                arr[i] = val.id;                            });                            var newarr = [];                            angular.forEach(arr, function(aid){                                angular.forEach($scope.Items, function(obj){                                    if(obj.id== aid){                                        newarr.push(obj);                                        return false;                                    }                                });                            });	                            $scope.Items = newarr;                        });                    });                });            }                        $scope.addItem = function(Nid){                var Mid = 'M'+new Date().getTime();                var Navs = $scope.navs;                angular.forEach(Navs, function(n,index) {                    if(n.id==Nid){                        newparams = !clone(n.params)?'':clone(n.params);                        newdata = !n.data?'':cloneArr(n.data);                        newother = !clone(n.other)?'':clone(n.other);                        newcontent = !clone(n.content)?'':clone(n.content);                        if(Nid=='cube'){                            for (row = 0; row < 4; row++) {                                 for (newparams.layout[row] = {}, col = 0; col < 4; col++) {                                    newparams.layout[row][col] = {cols: 1,rows: 1,isempty: !0,imgurl: "",classname: ""};                                }                            }                        }                        var newitem = {id:Mid,temp:Nid,params:newparams,data:newdata,other:newother,content:newcontent};                        var insertindex = -1;                        if($scope.focus!=''){                              var Items = $scope.Items;                                angular.forEach(Items, function(a,index) {                                    if(a.id==$scope.focus){                                        insertindex = index;                                    }                              });                        }                        if(insertindex==-1){                            $scope.Items.push(newitem);                        }                        else{                           $scope.Items.splice(insertindex+1, 0, newitem);                                     }                        //$("div[id="+newitem.id+"]").trigger('ng-click');                        setTimeout(function(){                       $scope.setfocus(newitem.id,null);                             },100);                                               //console.log($scope.Items);                    }                });            }            $scope.delItem = function(id){                if(confirm("此操作不可逆，确认移除？")){                    var Items = $scope.Items;                    angular.forEach(Items, function(a,index) {                        if(a.id==id){                            Items.splice(index,1);                            $scope.focus = '';                        }                    });                }            }            $scope.over = function(id){$("div[id="+id+"]").parent().find(".fe-mod-del").stop().show();}            $scope.out = function(id){$("div[id="+id+"]").parent().find(".fe-mod-del").stop().hide();}            $scope.save = function(n){               var pageid = "{$pageid}";                var stylename = "{$stylename}";               var items = cloneArr($scope.Items );               angular.forEach(items, function(m,index1) {                   if(m.temp=='richtext'){                        m.content = escape(m.content);                   }               });               var datas = angular.toJson(items);               var pageinfo = angular.toJson($scope.pages);               var pagename = $("input[name=pagename]").val();               var pagetype = $("input[name=pagetype]").val();               if(!pagename){                   alert('改页面还没有取名字');                   return;               }               if(!pagetype){                   alert('你还没有选择页面的类型哦~');                   return;               }               if(window.dosave=='1'){                   alert('触发关键字已存在！请重新填写。');                   $scope.focus = 'M0000000000000';                   return;               }               $(".fe-save-submit").text('保存中...').addClass("fe-save-disabled").data('saving','1');               $(".fe-save-submit2").css("color","#bbb");               if($(".fe-save-submit").data('saving')==1){                    $.ajax({                        type: 'POST',                        url: "{php echo $this->createWebUrl('templates',array('op'=>'api','apido'=>'savepage'))}",                        data: {pageid: pageid,datas:datas,pagetype:pagetype,pagename:pagename,pageinfo:pageinfo,stylename:stylename,},                        success: function(data){                            if(n==2){                                alert("保存成功！正在生成览页面...");                                setcookie(data);                                if(!pageid){                                    location.href = "{php echo $this->createWebUrl('templates',array('op'=>'designer'))}&pageid="+data+"&stylename="+stylename+"&pagetype="+pagetype;                                }else{                                    preview(data);                                }                            }else{                                alert("保存成功！");                                if(!pageid){                                    location.href = "{php echo $this->createWebUrl('templates',array('op'=>'designer'))}&pageid="+data+"&stylename="+stylename+"&pagetype="+pagetype;                                }                            }                            $(".fe-save-submit").text('保存').removeClass("fe-save-disabled").data('saving','0');                            $(".fe-save-submit2").css("color","#4bb5fb")                        }                        ,error: function(){                            alert('保存失败请重试');                            $(".fe-save-submit").text('保存').removeClass("fe-save-disabled").data('saving','0');                            $(".fe-save-submit2").css("color","#4bb5fb")                        }                    });               }            }            $scope.addGood = function(action,Mid,Gid){                $('#floating-good').modal();                $('#floating-good').attr({'action':action,'Gid':Gid});            }            $scope.delGood = function(Mid,Gid){                if(confirm("此操作不可逆，确认移除？")){                    var Items = $scope.Items;                    angular.forEach(Items, function(m,index1) {                        if(m.id==Mid){                            angular.forEach(m.data, function(g,index2) {                                if(g.id==Gid){                                    m.data.splice(index2,1);                                }                            });                        }                    });                }            }            $scope.delPic = function(Mid,type){                if(confirm("此操作不可逆，确认移除？")){                    if(type=='floatimg'){                        $scope.pages[0].params.floatimg = '';                    }else if(type=='voteanimg'){                        $scope.pages[0].params.voteanimg = '';                    }else if(type=='tongjibgimg'){                        $scope.pages[0].params.tongjibgimg = '';                    }else{                        $scope.pages[0].params.img = '';                    }                    //$("div[mid="+Mid+"]").trigger("click");                }            }            $scope.shopImg = function(Mid){                require(['jquery', 'util'], function($, util){                    util.image('',function(data){                       var Items = $scope.Items;                       angular.forEach(Items, function(m,index1) {                           if(m.id==Mid){                               m.params.bgimg = data['url'];                               $("div[mid="+Mid+"]").mouseover();                           }                       });                    });                });            }                        $scope.pageImg = function(Mid,type){                require(['jquery', 'util'], function($, util){                    util.image('',function(data){                        if(type=='floatimg'){                            $scope.pages[0].params.floatimg = data['url'];                        }else if(type=='voteanimg'){                            $scope.pages[0].params.voteanimg = data['url'];                        }else if(type=='tongjibgimg'){                            $scope.pages[0].params.tongjibgimg = data['url'];                        }else{                            $scope.pages[0].params.img = data['url'];                        }                       $("div[mid="+Mid+"]").trigger("click");                    });                });            }            $scope.$on('ngRepeatFinished',function(ngRepeatFinishedEvent){                $('.fe-mod-2 .swipe').each(function(){                        initswipe($(this));                 })                 $('.fe-mod-8-main-img img').each(function(){                     $(this).height($(this).width());                     });                 $('.fe-mod-12 img').each(function(){                     $(this).height($(this).width());                     });            });    }]);    myModel.directive('stringHtml' , function(){        return function(scope , el , attr){            if(attr.stringHtml){                scope.$watch(attr.stringHtml , function(html){                    el.html(html || '');                });            }        };    });      myModel.directive("onFinishRenderFilters",function($timeout){        return{            restrict: 'A',            link: function(scope,element,attr){                if(scope.$last === true){                    $timeout(function(){                        scope.$emit('ngRepeatFinished');                    });                }            }        };    });</script>
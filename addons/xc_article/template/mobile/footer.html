<div id="footer">
{if $detail['adv_on_off'] == 'on'}
    {php echo htmlspecialchars_decode($detail['adv_bottom']); }
{/if}

{if empty($footer_off)}
  {if !empty($_W['account']['siteinfo']['footer'])}
    {php echo htmlspecialchars_decode($_W['account']['siteinfo']['footer'])}
  {else}
    &copy;{if empty($_W['account']['name'])}微擎团队{else}{$_W['account']['name']}{/if}
  {/if}
{/if}
</div>

{if $_W['quickmenu']['menus']}
	{template $_W['quickmenu']['template']}
{/if}
<script type="text/javascript">
$(function() {
	$(".user-box .box-item").each(function(i) {
		i = i +1;
		if(i%3 == 0) $(this).css("border-right", "0");
	});
	$(window).scroll(function(){
		$(".menu-button").find("i").removeClass("icon-minus-sign").addClass("icon-plus-sign");
		$(".menu-main").hide();
	});
	$(".menu-main a").click(function(){ $(".menu-main").hide(); });

	//控制tab宽度
	var profile_tab = $(".nav-tabs li");
	profile_tab.css({"width": 100/profile_tab.length+"%", "text-align": "center"});

	//手机表单处理
	$(".form-table").delegate(".checkbox input[type='checkbox']", "click", function(){
		$(this).parent().toggleClass("btn-inverse");
	});
	$(".form-table").delegate(".file input[type='file']", "change", function(){
		var a = $(this).next("button");
		a.html(a.html() +' '+  $(this).val());
	});

	//处理固定横向导航条
	var navbarFixedTop = false, navbarFixedBottom = false;
	navbarFixedTop = $(".navbar").hasClass("navbar-fixed-top");
	navbarFixedBottom = $(".navbar").hasClass("navbar-fixed-bottom");
	if(navbarFixedTop) $("body").css("padding-top", "41px");
	if(navbarFixedBottom) $("body").css("padding-bottom", "41px");
});

//对分享时的数据处理
function _removeHTMLTag(str) {
	str = str.replace(/<script[^>]*?>[\s\S]*?<\/script>/g,'');
	str = str.replace(/<style[^>]*?>[\s\S]*?<\/style>/g,'');
    str = str.replace(/<\/?[^>]*>/g,'');
    str = str.replace(/\s+/g,'');
    str = str.replace(/&nbsp;/ig,'');
    return str;
}
document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
	<?php
		$_share = array();
		$_share['title'] = (empty($title)) ? $_W['account']['name'] : $title;
		$_share['link'] = 'http://'.$_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . '&wxref=mp.weixin.qq.com&linkurl=' . base64_encode($detail['linkurl']);
		$_share['img'] = $_W['siteroot'] . 'source/modules/' . $_GPC['name'] . '/icon.jpg';
	?>
	var _share_img = $('body img:eq(0)').attr("src");
  if(typeof(_share_img) == "undefined") _share_img = "{$_share['img']}";
  // use user setting first
  var _share_content = {if empty($detail['description'])} _removeHTMLTag($('body').html()).replace("{$_share['title']}",''); {else} "{php echo str_replace(array("\r\n", "\r", "\n"), '', $detail['description']);}";  {/if}

  _share_img = {if empty($detail['thumb'])} _share_img; {else} '{php echo  $detail['thumb']}'; {/if}



	window.shareData = {
		"imgUrl": _share_img,
		"timeLineLink": "{$_share['link']}",
		"sendFriendLink": "{$_share['link']}",
		"weiboLink": "{$_share['link']}",
		"tTitle": "{$_share['title']}",
		"tContent":  _share_content,
		"fTitle": "{$_share['title']}",
		"fContent":  _share_content,
		"wContent":  "{$_share['title']}"
	};

	function _report(share_type, share_msg) {
		switch (share_type) {
			case "send_msg":
			case "timeline":
			case "weibo":
			default:
				$.post(
					'{php echo $this->createMobileUrl('ShareTrack')}',
					{ id: "{$detail['id']}", track_type: 'share', track_sub_type: share_type, msg: share_msg ,track_id : "{$_W['fans']['from_user']}" },
					function(m){},
					"json");
				break;
		}
	}

	// 发送给好友
	WeixinJSBridge.on('menu:share:appmessage', function (argv) {
		WeixinJSBridge.invoke('sendAppMessage', {
			"img_url": window.shareData.imgUrl,
			"img_width": "640",
			"img_height": "640",
			"link": window.shareData.sendFriendLink,
			"desc": window.shareData.fContent,
			"title": window.shareData.fTitle
		}, function (res) {
			//_report('send_msg', res.err_msg);
		})
	});
	// 分享到朋友圈
	WeixinJSBridge.on('menu:share:timeline', function (argv) {
		WeixinJSBridge.invoke('shareTimeline', {
			"img_url": window.shareData.imgUrl,
			"img_width": "640",
			"img_height": "640",
			"link": window.shareData.timeLineLink,
			"desc": window.shareData.tContent,
			"title": window.shareData.tTitle
		}, function (res) {
			// 不起作用，回调没有发生
			//_report('timeline', res.err_msg);
		});
		// FIXME: weixin接口不支持往timeline分享的回调
		//XXX: 现在临时的方案是只要点了分享，就总给用户积分，最多给一次
		//_report('timeline', res.err_msg);
	});
}, false);
</script>
{if empty($main_off)}</div>{/if}
</body>
</html>
